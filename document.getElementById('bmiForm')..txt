document.getElementById('bmiForm').addEventListener('submit', function(e) {
    e.preventDefault(); // フォームの送信を阻止
    
    const heightCm = parseFloat(document.getElementById('height').value);
    const weightKg = parseFloat(document.getElementById('weight').value);
    
    if (isNaN(heightCm) || isNaN(weightKg) || heightCm <= 0 || weightKg <= 0) {
        alert('有効な身長と体重を半角数字で入力してください。');
        return;
    }
    
    // 身長をメートルに変換 (例: 170cm -> 1.7m)
    const heightM = heightCm / 100;
    
    // BMIの計算: 体重(kg) / (身長(m) * 身長(m))
    const bmi = weightKg / (heightM * heightM);
    
    // 結果の表示
    displayBMIResult(bmi);
    
    // 体重履歴の保存と表示
    saveWeightHistory(weightKg);
    displayWeightHistory();
});

/**
 * BMIの値を表示し、カテゴリを判定する関数
 * @param {number} bmi 計算されたBMIの値
 */
function displayBMIResult(bmi) {
    const bmiValueElement = document.getElementById('bmiValue');
    const bmiCategoryElement = document.getElementById('bmiCategory');
    let category = '';
    let categoryClass = '';
    
    const roundedBMI = bmi.toFixed(1); // 小数点以下1桁に丸める
    
    // BMIカテゴリの判定 (日本肥満学会の基準例)
    if (bmi < 18.5) {
        category = '低体重 (やせ)';
        categoryClass = 'underweight';
    } else if (bmi < 25.0) {
        category = '普通体重';
        categoryClass = 'normal';
    } else if (bmi < 30.0) {
        category = '肥満 (1度)';
        categoryClass = 'overweight';
    } else {
        category = '肥満 (2度以上)';
        categoryClass = 'obese';
    }
    
    bmiValueElement.textContent = `BMI: ${roundedBMI}`;
    bmiCategoryElement.textContent = `判定: ${category}`;
    
    // 結果エリアのスタイルを動的に変更したい場合は、CSSと連携
    const resultArea = document.getElementById('resultArea');
    resultArea.className = 'result-area ' + categoryClass;
}

/**
 * 体重の履歴をローカルストレージに保存する関数
 * @param {number} weightKg 現在の体重
 */
function saveWeightHistory(weightKg) {
    // ローカルストレージから既存の履歴を取得 (存在しない場合は空の配列)
    let history = JSON.parse(localStorage.getItem('weightHistory')) || [];
    
    const date = new Date().toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    });
    
    const time = new Date().toLocaleTimeString('ja-JP', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const newEntry = {
        date: date,
        time: time,
        weight: weightKg.toFixed(1)
    };
    
    // 新しいエントリを履歴の先頭に追加
    history.unshift(newEntry);
    
    // 履歴を最新10件などに制限したい場合はここで処理 (例: history.splice(10);)
    
    // ローカルストレージに保存
    localStorage.setItem('weightHistory', JSON.stringify(history));
}

/**
 * 体重の履歴を画面に表示する関数
 */
function displayWeightHistory() {
    const historyList = document.getElementById('weightHistory');
    historyList.innerHTML = ''; // リストをクリア
    
    let history = JSON.parse(localStorage.getItem('weightHistory')) || [];
    
    if (history.length === 0) {
        historyList.innerHTML = '<li>まだ履歴がありません。</li>';
        return;
    }
    
    history.forEach(entry => {
        const listItem = document.createElement('li');
        listItem.textContent = `${entry.date} ${entry.time}: ${entry.weight} kg`;
        historyList.appendChild(listItem);
    });
}

// ページ読み込み時に履歴を表示
displayWeightHistory();